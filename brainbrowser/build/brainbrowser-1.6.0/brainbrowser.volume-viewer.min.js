/*
* BrainBrowser: Web-based Neurological Visualization Tools
* (https://brainbrowser.cbrain.mcgill.ca)
*
* Copyright (C) 2011
* The Royal Institution for the Advancement of Learning
* McGill University
*
* This program is free software: you can redistribute it and/or modify
* it under the terms of the GNU Affero General Public License as
* published by the Free Software Foundation, either version 3 of the
* License, or (at your option) any later version.
*
* This program is distributed in the hope that it will be useful,
* but WITHOUT ANY WARRANTY; without even the implied warranty of
* MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
* GNU Affero General Public License for more details.
*
* You should have received a copy of the GNU Affero General Public License
* along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

/*
* BrainBrowser v1.6.0
*
* Author: Tarek Sherif  <tsherif@gmail.com> (http://tareksherif.ca/)
* Author: Nicolas Kassis
*/
!function(){"use strict";var a="1.6.0";a=a.indexOf("BRAINBROWSER_VERSION")>0?"D.E.V":a,window.BrainBrowser={version:a},window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){return window.setTimeout(a,1e3/60)},window.cancelAnimationFrame=window.cancelAnimationFrame||function(a){window.clearTimeout(a)}}(),function(){"use strict";BrainBrowser.createColorMap=function(a){function b(a,b,d,e){var f,g,h,i=document.createElement("canvas"),j=new Array(256);for($(i).attr("width",256),$(i).attr("height",d),f=0;256>f;f++)e?j[255-f]=f:j[f]=f;for(a=c.mapColors(j,{scale255:!0}),h=i.getContext("2d"),g=0;256>g;g++)h.fillStyle="rgb("+Math.floor(a[4*g])+", "+Math.floor(a[4*g+1])+", "+Math.floor(a[4*g+2])+")",h.fillRect(g,0,1,b);return i}var c={createCanvasWithScale:function(a,d,e){e=e||{};var f,g,h=c.colors,i=e.flip,j=d-a;return f=b(h,20,40,i),g=f.getContext("2d"),g.fillStyle="#FFA000",g.fillRect(.5,20,1,10),g.fillText(a.toPrecision(3),.5,40),g.fillRect(f.width/4,20,1,10),g.fillText((a+.25*j).toPrecision(3),.25*f.width,40),g.fillRect(f.width/2,20,1,10),g.fillText((a+.5*j).toPrecision(3),.5*f.width,40),g.fillRect(3*f.width/4,20,1,10),g.fillText((a+.75*j).toPrecision(3),.75*f.width,40),g.fillRect(f.width-.5,20,1,10),g.fillText(d.toPrecision(3),f.width-20,40),f},mapColors:function(a,b){b=b||{};var d,e,f,g,h=void 0===b.min?0:b.min,i=void 0===b.max?255:b.max,j=void 0===b.scale255?!1:b.scale255,k=void 0===b.brightness?0:b.brightness,l=void 0===b.contrast?1:b.contrast,m=void 0===b.alpha?1:b.alpha,n=b.destination||[],o=c.colors,p=o.length,q=i-h,r=(q+q/p)/p,s=j?255:1,t=[];for(m*=s,d=0,e=a.length;e>d;d++)g=a[d],f=h>=g?0:a[d]>i?p-1:Math.floor((g-h)/r),t=o[f]||[0,0,0],n[4*d+0]=s*(t[0]*l+k),n[4*d+1]=s*(t[1]*l+k),n[4*d+2]=s*(t[2]*l+k),n[4*d+3]=m;return n}};return function(){if(a){a=a.replace(/^\s+/,"").replace(/\s+$/,"");var b,d,e,f,g,h=a.split(/\n/),i=[];for(b=0,e=h.length;e>b;b++)if(g=h[b].replace(/^\s+/,"").replace(/\s+$/,"").split(/\s+/).slice(0,4),f=g.length,!(3>f)){for(d=0;f>d;d++)g[d]=parseFloat(g[d]);4>f&&g.push(1),i.push(g)}c.colors=i}}(),c}}(),function(){"use strict";var a=[];BrainBrowser.events={addEventListener:function(b,c){a[b]||(a[b]=[]),a[b].push(c)},triggerEvent:function(b){var c=Array.prototype.slice.call(arguments,1);a[b]&&a[b].forEach(function(a){setTimeout(function(){a.apply(null,c)},0)})}}}(),function(){"use strict";var a=BrainBrowser.loader={loadFromURL:function(b,c,d){d=d||{};var e,f=new XMLHttpRequest,g=d.result_type,h=b.split("/"),i=h[h.length-1];f.open("GET",b),"arraybuffer"===g&&(f.responseType="arraybuffer"),f.onreadystatechange=function(){if(4===f.readyState){if(e=f.status,!(e>=200&&300>e||304===e)){var g="error loading URL: "+b+"\nHTTP Response: "+f.status+"\nHTTP Status: "+f.statusText+"\nResponse was: \n"+f.response;throw BrainBrowser.events.triggerEvent("error",g),new Error(g)}a.checkCancel(d)||c(f.response,i,d)}},f.send()},loadFromFile:function(a,b,c){var d=a.files;if(0!==d.length){c=c||{};var e=c.result_type,f=new FileReader,g=a.value.split("\\"),h=g[g.length-1];f.file=d[0],f.onloadend=function(a){b(a.target.result,h,c)},f.onerror=function(){var a="error reading file: "+h;throw BrainBrowser.events.triggerEvent("error",a),new Error(a)},"arraybuffer"===e?f.readAsArrayBuffer(d[0]):f.readAsText(d[0])}},loadColorMapFromURL:function(a,b,c){BrainBrowser.loader.loadFromURL(a,function(a,c,d){b(BrainBrowser.createColorMap(a),c,d)},c)},loadColorMapFromFile:function(a,b,c){BrainBrowser.loader.loadFromFile(a,function(a,c,d){b(BrainBrowser.createColorMap(a),c,d)},c)},checkCancel:function(a){a=a||{},BrainBrowser.utils.isFunction(a)&&(a={test:a});var b=a.test,c=a.cleanup,d=!1;return b&&b()&&(d=!0,c&&c()),d}}}(),function(){"use strict";BrainBrowser.utils={canvasEnabled:function(){return!!document.createElement("canvas")},webglEnabled:function(){var a=document.createElement("canvas");try{return!(!a||!window.WebGLRenderingContext||!a.getContext("webgl")&&!a.getContext("experimental-webgl"))}catch(b){return!1}},webWorkersEnabled:function(){return!!window.Worker},webGLErrorMessage:function(){var a,b='BrainBrowser requires <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">WebGL</a>.<br/>';return b+=window.WebGLRenderingContext?"Your browser seems to support it, but it is <br/> disabled or unavailable.<br/>":"Your browser does not seem to support it.<br/>",b+='Test your browser\'s WebGL support <a href="http://get.webgl.org/">here</a>.',a=document.createElement("div"),a.id="webgl-error",a.innerHTML=b,a},isFunction:function(a){return a instanceof Function||"function"==typeof a},isNumeric:function(a){return!isNaN(parseFloat(a))},min:function(){var a=Array.prototype.slice.call(arguments);a=1===a.length&&Array.isArray(a[0])?a[0]:a;var b,c,d=a[0];for(b=1,c=a.length;c>b;b++)a[b]<d&&(d=a[b]);return d},max:function(){var a=Array.prototype.slice.call(arguments);a=1===a.length&&Array.isArray(a[0])?a[0]:a;var b,c,d=a[0];for(b=1,c=a.length;c>b;b++)a[b]>d&&(d=a[b]);return d},getOffset:function(a){for(var b=0,c=0;a.offsetParent;)b+=a.offsetTop,c+=a.offsetLeft,a=a.offsetParent;return{top:b,left:c}},checkConfig:function(a){if(!BrainBrowser.config)return!1;a=a||"";var b,c,d,e=BrainBrowser.config,f=a.split(".");for(c=0,d=f.length;d>c;c++){if(b=f[c],!e[b])return!1;e=e[b]}return!0}}}(),function(){"use strict";var a=BrainBrowser.VolumeViewer={};a.modules={},a.volume_loaders={},a.start=function(b,c){function d(b,c,d){var e=a.utils.axis_to_number[c],g=f.volumes[b],h=g.display[e];h.setSlice(d),h.updateCursor()}function e(){document.addEventListener("keydown",function(a){if(f.active_canvas){var b=f.active_canvas,c=a.which;if(!(37>c||c>40)){a.preventDefault(),a.stopPropagation();var d=f.active_cursor,e=b.getAttribute("data-volume-id"),g=b.getAttribute("data-axis-name");return{37:function(){d.x--},38:function(){d.y--},39:function(){d.x++},40:function(){d.y++}}[c](),f.setCursor(e,g,d),f.synced&&f.volumes.forEach(function(a,b){b!==e&&f.setCursor(b,g,d)}),!1}}},!1)}var f={dom_element:document.getElementById(b),volumes:[],synced:!1,panel_width:256,panel_height:256};Object.keys(a.modules).forEach(function(b){a.modules[b](f)}),console.log("BrainBrowser Volume Viewer v"+BrainBrowser.version);var g={};f.fetchSlice=function(b,c,e,h){g[b]=g[b]||{},clearTimeout(g[b][c]),g[b][c]=setTimeout(function(){var g,i=f.volumes[b],j=a.utils.axis_to_number[c];void 0!==e&&(i.position[c]=e),g=i.slice(c),g.vol_id=b,g.axis_number=j,g.min=i.min,g.max=i.max,d(b,c,g),BrainBrowser.events.triggerEvent("sliceupdate"),BrainBrowser.utils.isFunction(h)&&h(g)},0)},f.setPanelSize=function(a,b,c){c=c||{};var d,e,g,h=c.scale_image;h&&(d=f.panel_width,e=f.panel_height,g=Math.min(a/d,b/e)),f.panel_width=a>0?a:f.panel_width,f.panel_height=b>0?b:f.panel_height,f.volumes.forEach(function(d,e){d.display.forEach(function(d,i){d.setSize(f.panel_width,f.panel_height,c),h&&(d.zoom=d.zoom*g,d.image_center.x=a/2,d.image_center.y=b/2,f.setCursor(e,["xspace","yspace","zspace"][i],{x:d.image_center.x,y:d.image_center.y}))})}),h&&f.redrawVolumes()},e(),c(f)}}(),function(){"use strict";function a(a){var b={x:0,y:0};return a.addEventListener("mousemove",function(c){var d,e,f=BrainBrowser.utils.getOffset(a);void 0!==c.pageX?(d=c.pageX,e=c.pageY):(d=c.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,e=c.clientY+document.body.scrollTop+document.documentElement.scrollTop),b.x=d-f.left,b.y=e-f.top},!1),b}var b={setSize:function(a,b){this.canvas.width=a,this.canvas.height=b},setSlice:function(a){this.slice=a,this.slice_image=this.slice.getImage(this.zoom)},updateCursor:function(){var a=this.volume,b=this.slice,c=this.getImageOrigin();this.cursor.x=a.position[b.width_space.name]*Math.abs(b.width_space.step)*this.zoom+c.x,this.cursor.y=(b.height_space.space_length-a.position[b.height_space.name])*Math.abs(b.height_space.step)*this.zoom+c.y},followCursor:function(a){var b=a.x-this.last_cursor.x,c=a.y-this.last_cursor.y;this.image_center.x+=b,this.image_center.y+=c,this.cursor.x+=b,this.cursor.y+=c,this.last_cursor.x=a.x,this.last_cursor.y=a.y},reset:function(){this.zoom=1,this.image_center.x=this.canvas.width/2,this.image_center.y=this.canvas.height/2},getImageOrigin:function(){return{x:this.image_center.x-this.slice_image.width/2,y:this.image_center.y-this.slice_image.height/2}},drawSlice:function(){var a,b=this.slice_image;b&&(a=this.getImageOrigin(),this.context.putImageData(b,a.x,a.y))},drawCursor:function(a){var b=this.context,c=this.zoom,d=8;a=a||"#FF0000",b.save(),b.strokeStyle=a,b.translate(this.cursor.x,this.cursor.y),b.scale(c,c),b.lineWidth=2,b.beginPath(),b.moveTo(0,-d),b.lineTo(0,-2),b.moveTo(0,2),b.lineTo(0,d),b.moveTo(-d,0),b.lineTo(-2,0),b.moveTo(2,0),b.lineTo(d,0),b.stroke(),b.restore()}};BrainBrowser.VolumeViewer.createPanel=function(c){c=c||{};var d={cursor:{x:0,y:0},last_cursor:{x:0,y:0},image_center:{x:0,y:0},zoom:1},e=Object.create(b);return Object.keys(d).forEach(function(a){e[a]=d[a]}),Object.keys(c).forEach(function(a){e[a]=c[a]}),e.canvas&&BrainBrowser.utils.isFunction(e.canvas.getContext)&&(e.context=e.canvas.getContext("2d"),e.mouse=a(e.canvas)),e}}(),function(){"use strict";function a(a,b,c,d,e,f){var g,h,i,j,k,l=[];for(f=f||1,g=0;b>g;g++)for(h=0;c>h;h++)for(j=d?b-g-1:g,k=e?c-h-1:h,i=0;f>i;i++)l[(h*b+g)*f+i]=a[(k*b+j)*f+i];return l}BrainBrowser.VolumeViewer.utils={axis_to_number:{xspace:0,yspace:1,zspace:2},nearestNeighbor:function(b,c,d){var e=b.data,f=b.width,g=b.height,h=document.createElement("canvas").getContext("2d"),i=4;if(f===c&&g===d)return b;0>c&&d>0&&(e=a(e,f,g,!0,!1,i)),c=Math.abs(c),d=Math.abs(d);for(var j=h.createImageData(c,d),k=j.data,l=f/c,m=g/d,n=0;d>n;n++)for(var o=0;c>o;o++)for(var p=Math.floor(o*l),q=Math.floor(n*m),r=0;i>r;r++)k[Math.floor(n*c+o)*i+r]=e[Math.floor(q*f+p)*i+r];return j},rotateUint16Array90Left:function(a,b,c){var d,e,f=new Uint16Array(b*c);for(d=0;b>d;d++)for(e=0;c>e;e++)f[d*c+e]=a[e*b+(b-d)];return f},rotateUint16Array90Right:function(a,b,c){var d,e,f=new Uint16Array(b*c);for(d=0;b>d;d++)for(e=0;c>e;e++)f[d*c+e]=a[(c-e)*b+d];return f}}}(),BrainBrowser.VolumeViewer.modules.loading=function(a){"use strict";function b(a,b){var c,d=h.volume_loaders[a.type];if(!d)throw c="Unsuported Volume Type",BrainBrowser.events.triggerEvent("error",c),new Error(c);d(a,b)}function c(c,d,e){b(d,function(b){var f=0;a.volumes[c]=b,b.display=g(a.dom_element,c,d),b.color_map=a.default_color_map,["xspace","yspace","zspace"].forEach(function(d){var g=b.position[d]=Math.floor(b.header[d].space_length/2);a.fetchSlice(c,d,g,function(){3===++f&&BrainBrowser.utils.isFunction(e)&&e(b)})})})}function d(b,c,d){b.cursor_color=c,a.default_color_map=b,BrainBrowser.utils.isFunction(d)&&d(b)}function e(b,c,d,e){c.cursor_color=d,a.setVolumeColorMap(b,c),BrainBrowser.utils.isFunction(e)&&e(a.volumes[b],c)}function f(a,b,c,d){var e=document.getElementById(c).innerHTML.replace(/\{\{VOLID\}\}/gm,b),f=document.createElement("div");f.innerHTML=e;var g,h,i,j=f.childNodes,k=f.getElementsByClassName(d)[0];for(g=0,h=a.childNodes.length;h>g;g++)i=a.childNodes[g],1===i.nodeType&&(k.appendChild(i),g--,h--);return j}function g(b,c,d){var e,g=document.createElement("div"),i=a.volumes[c],j=[],k=d.template||{};if(g.classList.add("volume-container"),["xspace","yspace","zspace"].forEach(function(b){var d=document.createElement("canvas");d.width=a.panel_width,d.height=a.panel_height,d.setAttribute("data-volume-id",c),d.setAttribute("data-axis-name",b),d.classList.add("slice-display"),d.style.backgroundColor="#000000",g.appendChild(d),j.push(h.createPanel({volume:i,axis:b,canvas:d,cursor:{x:d.width/2,y:d.height/2},image_center:{x:d.width/2,y:d.height/2}}))}),k.element_id&&k.viewer_insert_class&&(e=f(g,c,k.element_id,k.viewer_insert_class),"function"==typeof k.complete&&k.complete(i,e),Array.prototype.forEach.call(e,function(a){1===a.nodeType&&g.appendChild(a)})),a.volumeUIControls){var l=document.createElement("div");l.className="volume-viewer-controls volume-controls",a.volumeUIControls.defer_until_page_load?BrainBrowser.events.addEventListener("ready",function(){g.appendChild(l),a.volumeUIControls(l,i,c)}):(a.volumeUIControls(l,i,c),g.appendChild(l))}return function(){var b=null;["xspace","yspace","zspace"].forEach(function(d,e){function f(f){var g={x:l.x,y:l.y};f.target===b&&(f.shiftKey?(i.followCursor(g),a.synced&&a.volumes.forEach(function(a,b){b!==c&&a.display[e].followCursor(g)})):(a.setCursor(c,d,g),a.synced&&a.volumes.forEach(function(b,e){e!==c&&a.setCursor(e,d,g)}),i.cursor=a.active_cursor=g))}function g(){document.removeEventListener("mousemove",f,!1),document.removeEventListener("mouseup",g,!1),b=null}function h(b){var d=Math.max(-1,Math.min(1,b.wheelDelta||-b.detail));b.preventDefault(),b.stopPropagation(),i.zoom=Math.max(i.zoom+.05*d,.05),a.fetchSlice(c,["xspace","yspace","zspace"][e]),a.synced&&a.volumes.forEach(function(b,f){if(f!==c){var g=b.display[e];g.zoom=Math.max(g.zoom+.05*d,.05),a.fetchSlice(f,["xspace","yspace","zspace"][e])}})}var i=j[e],k=i.canvas,l=i.mouse;k.addEventListener("mousedown",function(h){b=h.target;var j={x:l.x,y:l.y};h.preventDefault(),h.stopPropagation(),h.shiftKey?(i.last_cursor.x=j.x,i.last_cursor.y=j.y,a.synced&&a.volumes.forEach(function(a,b){if(b!==c){var d=a.display[e];d.last_cursor.x=j.x,d.last_cursor.y=j.y}})):(a.setCursor(c,d,j),a.synced&&a.volumes.forEach(function(b,e){e!==c&&a.setCursor(e,d,j)}),i.cursor=a.active_cursor=j),a.active_canvas=h.target,document.addEventListener("mousemove",f,!1),document.addEventListener("mouseup",g,!1)},!1),k.addEventListener("mousewheel",h,!1),k.addEventListener("DOMMouseScroll",h,!1)})}(),b.appendChild(g),BrainBrowser.events.triggerEvent("volumeuiloaded",g,c),j}var h=BrainBrowser.VolumeViewer;a.loadVolumes=function(b){function d(d){c(d,g[d],function(){++j<h||(b.overlay&&h>1?a.createOverlay(f,function(){BrainBrowser.utils.isFunction(i)&&i(),BrainBrowser.events.triggerEvent("volumesloaded")}):(BrainBrowser.utils.isFunction(i)&&i(),BrainBrowser.events.triggerEvent("volumesloaded")))})}b=b||{};var e,f=b.overlay&&"object"==typeof b.overlay?b.overlay:{},g=b.volumes,h=b.volumes.length,i=b.complete,j=0;for(e=0;h>e;e++)d(e)},a.loadVolumeColorMapFromURL=function(a,b,c,d){BrainBrowser.loader.loadColorMapFromURL(b,function(b){e(a,b,c,d)})},a.loadDefaultColorMapFromURL=function(a,b,c){BrainBrowser.loader.loadColorMapFromURL(a,function(a){d(a,b,c)})},a.loadVolumeColorMapFromFile=function(a,b,c,d){BrainBrowser.loader.loadColorMapFromFile(b,function(b){e(a,b,c,d)})},a.loadDefaultColorMapFromFile=function(a,b,c){BrainBrowser.loader.loadColorMapFromFile(a,function(a){d(a,b,c)})},a.setVolumeColorMap=function(b,c){a.volumes[b].color_map=c},a.loadVolume=function(b,d){c(a.volumes.length,b,d)},a.clearVolumes=function(){a.volumes=[],a.active_canvas=null,a.active_cursor=null,a.dom_element.innerHTML=""},a.createOverlay=function(b,c){b=b||{},a.loadVolume({volumes:a.volumes,type:"overlay",template:b.template},c)}},BrainBrowser.VolumeViewer.modules.rendering=function(a){"use strict";var b=BrainBrowser.VolumeViewer;a.draw=function(){var b,c,d,e=4,f=e/2;a.volumes.forEach(function(g){g.display.forEach(function(h){c=h.canvas,b=h.context,b.globalAlpha=255,b.clearRect(0,0,c.width,c.height),d=g.color_map||a.default_color_map,h.drawSlice(),h.drawCursor(d.cursor_color),c===a.active_canvas&&(b.save(),b.strokeStyle="#EC2121",b.lineWidth=e,b.strokeRect(f,f,c.width-e,c.height-e),b.restore())})})},a.render=function(){BrainBrowser.events.triggerEvent("rendering"),function b(){window.requestAnimationFrame(b),a.draw()}()},a.setCursor=function(c,d,e){var f,g,h=a.volumes[c],i=b.utils.axis_to_number[d],j=h.display[i],k=j.slice,l=j.getImageOrigin(),m=j.zoom;j.cursor.x=e.x,j.cursor.y=e.y,e?(f=Math.floor((e.x-l.x)/m/Math.abs(k.width_space.step)),g=Math.floor(k.height_space.space_length-(e.y-l.y)/m/Math.abs(k.height_space.step))):(f=null,g=null),a.fetchSlice(c,k.width_space.name,f),a.fetchSlice(c,k.height_space.name,g)},a.redrawVolumes=function(){a.volumes.forEach(function(b,c){a.fetchSlice(c,"xspace",b.position.xspace),a.fetchSlice(c,"yspace",b.position.yspace),a.fetchSlice(c,"zspace",b.position.zspace)})},a.resetDisplays=function(){a.volumes.forEach(function(a){a.display.forEach(function(a){a.reset()})})}},function(){"use strict";function a(a,b){var c,d;try{c=JSON.parse(a)}catch(e){throw d="server did not respond with valid JSON\nResponse was: \n"+a,BrainBrowser.events.triggerEvent("error",d),new Error(d)}BrainBrowser.utils.isFunction(b)&&b(c)}function b(a,b,d){var f=Object.create(e);f.position={},f.current_time=0,f.data=c(a,new Uint8Array(b)),f.header=f.data.header,f.min=0,f.max=255,BrainBrowser.utils.isFunction(d)&&d(f)}function c(a,b){var c=Object.create(f);c.header=a,c.order=a.order,4===c.order.length&&(c.order=c.order.slice(1),c.time=a.time),c.xspace=a.xspace,c.yspace=a.yspace,c.zspace=a.zspace,c.xspace.name="xspace",c.yspace.name="yspace",c.zspace.name="zspace",c.xspace.space_length=parseFloat(c.xspace.space_length),c.yspace.space_length=parseFloat(c.yspace.space_length),c.zspace.space_length=parseFloat(c.zspace.space_length),c.xspace.start=parseFloat(c.xspace.start),c.yspace.start=parseFloat(c.yspace.start),c.zspace.start=parseFloat(c.zspace.start),c.xspace.step=parseFloat(c.xspace.step),c.yspace.step=parseFloat(c.yspace.step),c.zspace.step=parseFloat(c.zspace.step),4===c.order.length&&(c.time.space_length=parseFloat(c.time.space_length),c.time.start=parseFloat(c.time.start),c.time.step=parseFloat(c.time.step));var d=c[c.order[0]],e=c[c.order[1]],g=c[c.order[2]];return d.height=parseFloat(e.space_length),d.height_space=e,d.width=parseFloat(g.space_length),d.width_space=g,e.height=parseFloat(g.space_length),e.height_space=g,e.width=parseFloat(d.space_length),e.width_space=d,g.height=parseFloat(e.space_length),g.height_space=e,g.width=parseFloat(d.space_length),g.width_space=d,d.offset=parseFloat(e.space_length)*parseFloat(g.space_length),e.offset=parseFloat(d.space_length),g.offset=parseFloat(d.space_length),d.slice_length=d.height*d.width,c.cached_slices={},c.data=b,c}var d=BrainBrowser.VolumeViewer,e={slice:function(a,b,c){b=b||this.position[a],c=c||this.current_time;var e=this.data.slice(a,b,c);return e.color_map=this.color_map,e.min=this.min,e.max=this.max,e.axis=a,e.getImage=function(a){a=a||1;var b=document.createElement("canvas").getContext("2d"),c=e.color_map,f=b.createImageData(e.width,e.height);c.mapColors(e.data,{min:e.min,max:e.max,scale255:!0,brightness:0,contrast:1,alpha:e.alpha,destination:f.data});var g=e.width_space.step,h=e.height_space.step;return d.utils.nearestNeighbor(f,Math.floor(e.width*g*a),Math.floor(e.height*h*a))},e},getVoxelCoords:function(){return{x:this.position.xspace,y:this.position.yspace,z:this.position.zspace}},setVoxelCoords:function(a,b,c){this.position.xspace=a,this.position.yspace=b,this.position.zspace=c},getWorldCoords:function(){return{x:this.data.xspace.start+this.position.xspace*this.data.xspace.step,y:this.data.yspace.start+this.position.yspace*this.data.yspace.step,z:this.data.zspace.start+this.position.zspace*this.data.zspace.step}},setWorldCoords:function(a,b,c){this.position.xspace=Math.floor((a-this.data.xspace.start)/this.data.xspace.step),this.position.yspace=Math.floor((b-this.data.yspace.start)/this.data.yspace.step),this.position.zspace=Math.floor((c-this.data.zspace.start)/this.data.zspace.step)}},f={slice:function(a,b,c){var e,f=this.cached_slices,g=this[this.order[0]];if(c=c||0,f[a]=f[a]||[],f[a][c]=f[a][c]||[],this[a].step<0&&(b=this[a].space_length-b),void 0!==f[a][c][b])return e=f[a][c][b],e.alpha=1,e.number=b,e;if(void 0===this.order)return!1;var h=0;this.time&&(h=c*g.height*g.width*parseFloat(g.space_length));var i=this[a].width_space.step,j=this[a].height_space.step;e={};var k,l,m,n,o,p,q,r,s,t;if(this.order[0]===a)if(l=this[a].height*this[a].width,m=this[a].height,n=this[a].width,o=1,p=n,q=l,k=new Uint16Array(l),i>0)if(j>0)for(r=0;l>r;r++)k[r]=this.data[h+q*b+r];else for(r=m;r>0;r--)for(s=0;n>s;s++)k[(m-r)*n+s]=this.data[h+q*b+r*n+s];else if(0>j)for(r=0;m>r;r++)for(s=0;n>s;s++)k[r*n+s]=this.data[h+q*b+r*n+n-s];else for(r=m;r>0;r--)for(s=0;n>s;s++)k[(m-r)*n+s]=this.data[h+q*b+r*n+n-s];else if(this.order[1]===a)if(m=this[a].height,l=this[a].height*this[a].width,n=this[a].width,o=1,p=g.slice_length,q=g.width,k=new Uint8Array(l),0>j)for(s=0;m>s;s++)for(t=0;n>t;t++)k[s*n+t]=this.data[h+b*q+p*t+s];else for(s=m;s>=0;s--)for(t=0;n>t;t++)k[(m-s)*n+t]=this.data[h+b*q+p*t+s];else for(m=this[a].height,l=this[a].height*this[a].width,n=this[a].width,o=g.slice_length,p=g.width,q=1,k=new Uint16Array(l),s=0;m>s;s++)for(t=0;n>t;t++)k[s*n+t]=this.data[h+b+g.width*s+t*g.slice_length];return e.width_space=this[a].width_space,e.height_space=this[a].height_space,e.width=n,e.height=m,"xspace"===a&&"yspace"===this.xspace.height_space.name&&(k=this.zspace.step<0?d.utils.rotateUint16Array90Right(k,e.width,e.height):d.utils.rotateUint16Array90Left(k,e.width,e.height),e.width_space=this[a].height_space,e.height_space=this[a].width_space,e.width=m,e.height=n),"yspace"===a&&"xspace"===this.yspace.height_space.name&&(k=this.zspace.step<0?d.utils.rotateUint16Array90Right(k,e.width,e.height):d.utils.rotateUint16Array90Left(k,e.width,e.height),e.width_space=this[a].height_space,e.height_space=this[a].width_space,e.width=m,e.height=n),"zspace"===a&&"xspace"===this.zspace.height_space.name&&(k=d.utils.rotateUint16Array90Left(k,e.width,e.height),e.width_space=this[a].width_space,e.height_space=this[a].height_space,e.width=m,e.height=n),e.data=k,e.width_space=e.width_space||this[a].width_space,e.height_space=e.height_space||this[a].height_space,e.width=e.width||n,e.height=e.height||m,f[a][c][b]=e,e}};d.volume_loaders.minc=function(c,d){var e;if(c.header_url&&c.raw_data_url)BrainBrowser.loader.loadFromURL(c.header_url,function(e){a(e,function(a){BrainBrowser.loader.loadFromURL(c.raw_data_url,function(c){b(a,c,d)},{result_type:"arraybuffer"})})});else{if(!c.header_file||!c.raw_data_file)throw e="invalid volume description.\nDescription must contain property pair 'header_url' and 'raw_data_url', or\n'header_file' and 'raw_data_file'.",BrainBrowser.events.triggerEvent("error",e),new Error(e);BrainBrowser.loader.loadFromFile(c.header_file,function(e){a(e,function(a){BrainBrowser.loader.loadFromFile(c.raw_data_file,function(c){b(a,c,d)},{result_type:"arraybuffer"})})})}}}(),function(){"use strict";function a(a,b){var c,d,e,f,g,h,i,j=a.length,k=b.data,l=b.width,m=b.height,n=[];if(j>1){for(c=0;m>c;c+=1)for(e=0;l>e;e+=1)for(d=0;j>d;d+=1)n[d]=n[d]||0,f=a[d],c<f.height&&e<f.width&&(g=4*(c*l+e),h=(k[g+3]||0)/255,i=n[d],k[g]=(k[g+0]||0)*h+f.data[i+0]*(f.data[i+3]/255),k[g+1]=(k[g+1]||0)*h+f.data[i+1]*(f.data[i+3]/255),k[g+2]=(k[g+2]||0)*h+f.data[i+2]*(f.data[i+3]/255),k[g+3]=(k[g+3]||0)+f.data[i+3],n[d]+=4);for(c=3;c<k.length;c+=4)k[c]=255;return b}return a[0]}var b=BrainBrowser.VolumeViewer,c={slice:function(c,d,e){d=d||this.position[c],e=e||this.current_time;var f=this,g=[];return f.volumes.forEach(function(a,b){var h=a.slice(c,d,e);h.alpha=f.blend_ratios[b],g.push(h)}),{height_space:g[0].height_space,width_space:g[0].width_space,getImage:function(c){c=c||1;var d,e,f,h=document.createElement("canvas").getContext("2d"),i=[];return g.forEach(function(a){var d=a.color_map,e=h.createImageData(a.width,a.height),f=Math.floor(a.width*a.width_space.step*c),g=Math.floor(a.height*a.height_space.step*c);d.mapColors(a.data,{min:a.min,max:a.max,scale255:!0,brightness:0,contrast:1,alpha:a.alpha,destination:e.data}),e=b.utils.nearestNeighbor(e,f,g),i.push(e)}),d=i.reduce(function(a,b){return Math.max(a,b.width)},0),e=i.reduce(function(a,b){return Math.max(a,b.height)},0),f=h.createImageData(d,e),a(i,f)}}},getVoxelCoords:function(){return{x:this.position.xspace,y:this.position.yspace,z:this.position.zspace}},setVoxelCoords:function(a,b,c){this.position.xspace=a,this.position.yspace=b,this.position.zspace=c},getWorldCoords:function(){var a=this.volumes[0];return{x:a.data.xspace.start+this.position.xspace*a.data.xspace.step,y:a.data.yspace.start+this.position.yspace*a.data.yspace.step,z:a.data.zspace.start+this.position.zspace*a.data.zspace.step}},setWorldCoords:function(a,b,c){var d=this.volumes[0];this.position.xspace=Math.floor((a-d.data.xspace.start)/d.data.xspace.step),this.position.yspace=Math.floor((b-d.data.yspace.start)/d.data.yspace.step),this.position.zspace=Math.floor((c-d.data.zspace.start)/d.data.zspace.step)}};b.volume_loaders.overlay=function(a,b){a=a||{};var d=a.volumes||[],e=Object.create(c);e.type="overlay",e.position={},e.header=d[0]?d[0].header:{},e.min=0,e.max=255,e.volumes=[],e.blend_ratios=[],d.forEach(function(a){e.volumes.push(a),e.blend_ratios.push(1/d.length)}),BrainBrowser.utils.isFunction(b)&&b(e)}}();